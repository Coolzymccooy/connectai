# Work Log — 2026-02-10

## Summary (What Was Implemented)
- Background job isolation with a dedicated worker (`server/worker.js`) and a secure `/api/jobs/process` endpoint.
- Retention cleanup for Mongo and Firestore (calls, recordings, and messages).
- Monitoring/health checks via `/api/health` and `/api/health/deps`.
- Rate-limit tuning via environment variables.
- Retry/backoff on integration API calls.
- Smoke test suite for health endpoints.
- Load testing script for concurrency.
- Observability dashboard card (latency, errors, backlog).
- CI workflow for tests.
- Resource tuning via Mongo pool size + HTTP max sockets.
- UI tightening (calendar and campaigns sizing) plus inbox/dialer logic previously completed.
- Primary CRM set to `HubSpot`.
- Campaigns: core marketing fields (audience, channels, journey) + AI email drafting and templates.
- Leads: Add Lead modal + CSV import with mapping, preview, validation, and AI enrichment.
- Campaign execution: SendGrid email delivery + Termii SMS delivery in worker.
- Landing page branding: “Tech by Tiwaton” creative placement.
- Help Corner: in-app help tab with presets + AI answer bot.
- Access control: Only Admin/Supervisor can create campaigns or leads (UI guardrails).
- Supervisor Live Floor: active call list + monitoring selection panel (multi-call view).
- Twilio monitoring hooks: conference mode toggle + supervisor monitor endpoints.
- Monitoring UI: join/coach/break controls + live status badge.
- Supervisor risk audit now uses real calls only (simulation gated).
- Help Corner: presets + AI chat bot, with Gemini-backed answers.
- Leads: CSV mapping, validation, AI enrichment, and bulk import.
- Campaigns: AI draft + templates, email/sms content persisted in campaign payload.
- Campaign delivery: SendGrid email + Termii SMS worker delivery.
- Landing page: “Tech by Tiwaton” creative placement.

## End-to-End Session Notes

### Major Feature Additions
- **Campaign core essence**: audience filters, channels, journey steps, and metrics.
- **Campaign AI drafting**: generates subject/body using Gemini and stores on campaign.
- **Campaign delivery**: SendGrid email + Termii SMS via background worker.
- **Leads hub**: Add Lead modal, CSV import with column mapping, preview, validation, AI enrichment.
- **Help Corner**: preset Q&A + AI help bot.
- **Supervisor Live Floor**: active calls list, monitor controls (listen/whisper/barge), monitoring status badge.
- **Twilio monitoring hooks**: conference mode routing + monitor endpoints.
- **PWA**: manifest + service worker registration.
- **Admin Settings**: integrations, export hub, observability and guardrails UI improvements.
- **NDPR consent**: inbound WhatsApp consent stamping and UI actions.

### Key Files Touched
- `components/AgentConsole.tsx`
- `components/SupervisorDashboard.tsx`
- `components/AdminSettings.tsx`
- `components/LandingPage.tsx`
- `services/geminiService.ts`
- `server/index.js`
- `server/worker.js`
- `types.ts`
- `public/manifest.json`
- `public/sw.js`
- `index.tsx`
- `WORK_LOG_2026-02-10.md`
- `CHANGELOG.md`

### Environment Variables (Production + Local)
```bash
# Twilio monitoring
TWILIO_MONITORING_ENABLED=true
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
TWILIO_CALLER_ID=...

# Campaign delivery (email + sms)
SENDGRID_API_KEY=...
SENDGRID_FROM_EMAIL=...
TERMII_API_KEY=...
TERMII_BASE_URL=https://v3.api.termii.com
TERMII_SMS_ENDPOINT=/api/sms/send
TERMII_SMS_CHANNEL=generic
TERMII_SENDER_ID=YourSender

# AI features
GEMINI_API_KEY=...

# Simulation toggle (supervisor analytics)
VITE_DEV_SIMULATION=true
```

### How To Run
```bash
npm run dev
npm run dev:server
npm run dev:worker
```

### Testing
```bash
npm test
npm run build
npm run preview
```

### Known Notes / Caveats
- Supervisor monitoring uses **Twilio conference mode** when `TWILIO_MONITORING_ENABLED=true`.
- Help Corner AI requires `GEMINI_API_KEY`.
- AI Enrich and CSV mapping require parsed leads; button disabled until preview is done.
- In production, **disable simulation** unless needed: remove `VITE_DEV_SIMULATION=true`.

## Servers: How To Start

### 1) API server
```bash
npm run dev:server
```

### 2) Worker (job processor)
```bash
npm run dev:worker
```

### Optional: Run both UI + API
```bash
npm run dev:all
```

## Environment Variables (Recommended)

### Worker isolation
```bash
RUN_JOB_WORKER_INLINE=false
WORKER_BASE_URL=http://localhost:8787
WORKER_TOKEN=CHANGE_ME_TO_A_LONG_RANDOM_SECRET
JOB_WORKER_INTERVAL_MS=30000
JOB_BACKLOG_WARN_THRESHOLD=20
```

### Retention policies
```bash
CALL_RETENTION_DAYS=90
RECORDING_RETENTION_DAYS=30
```

### Rate-limit tuning (defaults applied if missing)
```bash
API_RATE_LIMIT_WINDOW_MS=900000
API_RATE_LIMIT_MAX=150
TWILIO_RATE_LIMIT_WINDOW_MS=60000
TWILIO_RATE_LIMIT_MAX=200
AI_RATE_LIMIT_WINDOW_MS=60000
AI_RATE_LIMIT_MAX=90
```

### Resource tuning
```bash
MONGO_MAX_POOL_SIZE=20
MONGO_MIN_POOL_SIZE=2
HTTP_MAX_SOCKETS=128
```

### Campaign delivery (Email + SMS)
```bash
SENDGRID_API_KEY=your_sendgrid_api_key
SENDGRID_FROM_EMAIL=hello@yourdomain.com
TERMII_API_KEY=your_termii_api_key
TERMII_BASE_URL=https://v3.api.termii.com
TERMII_SMS_ENDPOINT=/api/sms/send
TERMII_SMS_CHANNEL=generic
TERMII_SENDER_ID=YourSender
```

### AI features (drafts + enrichment)
```bash
GEMINI_API_KEY=your_gemini_key
```

### Help bot
```bash
GEMINI_API_KEY=your_gemini_key
```

## Load Testing
```bash
npm run load:test
```

Optional:
```bash
LOAD_TEST_BASE_URL=http://localhost:8787
LOAD_TEST_CONCURRENCY=25
LOAD_TEST_ITERATIONS=50
LOAD_TEST_ENABLE_WEBHOOK=false
```

## Health Checks
```bash
GET /api/health
GET /api/health/deps
```

## Smoke Tests
```bash
npm test
```

Optional:
```bash
SMOKE_BASE_URL=http://localhost:8787 npm test
```

## GDPR/Privacy Controls Implemented
- PII masking for phone and email.
- Transcript redaction to remove emails/phone numbers.
- Retention policy enforcement (auto-expiry).
- Recording access restricted to authorized users.

### Notes For UK (GDPR)
- Supports data minimization via `anonymizePii`.
- Retention window enforced via `retentionDays`.
- Access control to recordings reduces unnecessary exposure.

### Notes For Nigeria (NDPR-aligned)
- Same controls apply (masking, redaction, retention).
- If you need NDPR-specific consent copy, we can add localized consent prompts.

## Files Updated
- `server/index.js`
- `server/worker.js`
- `server/models/index.js`
- `services/apiClient.ts`
- `services/geminiService.ts`
- `tests/smoke.test.js`
- `tests/integration.test.js`
- `scripts/load-test.mjs`
- `.github/workflows/ci.yml`
- `components/AdminSettings.tsx`
- `components/AgentConsole.tsx`
- `components/LandingPage.tsx`
- `components/AgentConsole.tsx`
- `types.ts`
- `App.tsx`
- `package.json`
